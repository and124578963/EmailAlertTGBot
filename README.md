# Телеграм бот уведомляющий о новых e-mail


# 1. Описание
Python MailModule читает письма из почты, фильтрует\модифицирует\преобразует в изображение их и сохраняет в MongoDB. 
Java telegram bot проверяет MongoDB на наличие неотправленных писем и отправляет их в активированные чаты с подпиской на
папку, из которой было вычитано письмо.

- Бот способен уведомлять вас в телеграмм о новых сообщениях из почты.
- Полезен как в личных чатах, так и в групповых.
- Уведомления могут быть о каждом входящем сообщении, либо только о самом первом в теме.
- Бот присылает вложения: изображения, логи.
- Есть система назначения ответственного за письмо, что позволяет распределять задачи в групповых чатах.
- Фильтрация и модификация писем по кастомным правилам в настройках


# 2. Быстрый старт
   1. После запуска бота, необходимо написать ему /start
   2. Для аутентификации в боте необходимо написать ему секретную фарзу из настроек бота
   3. После необходимо добавить подписку на почтовую папку. Для этого необходимо написать боту /add_subs и 
следующим сообщением название почтовой папки. Почтовая папка задается в настройках MailModule при выгрузке писем. 
Должна быть настроена выгрузка из этой почтовой папки.
   4. Если в MongoDB появляется письмо с такой папкой, то придет о нем уведомление в чат.
   5. Для удаления подписки аналогично /del_subs. Для получения списка подписанных папок /my_subs
   6. Чтобы отключить уведомления, необходимо либо удалить все подписки, либо деактивировать чат через /stop
   7. Если в настройках MailModule для почтовой папки включен режим назначения ответственного, то можно добавить
ответственного для выбора через команду /add_user и следующим сообщением "<Команда> - <имя человека>"
   8. Список команд регулируется через telegrambot.assignPulls в настройках TelegramAlertBot п. 4.1
   9. Для удаления человека из команды /del_user и следующим сообщением его имя.

# 3. Пререквизиты
1. Компоненты: 
   - MongoDB 6 (можно поднять через докер docker-compose.yaml) 
   - wkhtmltopdf 0.12.6 (Необходим для перевода html в картинку) https://wkhtmltopdf.org/downloads.html
   - python 3.8 
   - java 11+
   
2. Создать файл .env по образцу .env_example, где необходимо указать секреты:
   - DB_LOGIN - логин от базы данных mongodb
   - DB_PASSWRD - пароль от базы данных mongodb
   - TG_TOKEN - токен от телеграм бота
   - SECRET_PHRASE - придумайте секретную фразу для активации чата
   - Добавить переменные с секретами для подключения к почте, чтобы потом их использовать в настройках MailModule

3. Создать telegram бота через @BotFather, получить токен бота и добавить список команд:
  ```
   start - Запустить бота
   stop - Деактивировать бота
   add_user - Добавить пользователя в команду
   del_user - Удалить пользователя из команды
   add_subs - Добавить подписку на папку
   del_subs - Удалить подписку на папку
   my_subs - Мои подписки
   ```
4. Перед запуском из IDE на Windows, необходимо запустить ./win_load_env.psl чтобы загрузить переменные окружения из файла .env


# 4. Деплой
1. Скопируйте следующие файлы в папку на сервере:
   - attachments
   - logs
   - pythonMailModule
   - .env
   - application.properties
   - start.sh
2. Скомпилируйте jar файл, переименуйте и добавьте его в папку на сервере 

```
TelegramAlertBot-1.0-jar-with-dependencies.jar -> TelegramAlertBot.jar
``` 

3. Создайте виртуальной python окружение `python -m venv ./venv`
4. В start.sh укажите путь до текущей папки в HOME и укажите в JAVA_HOME путь до папки с java 11+.
5. Проверьте актуальность данных в п. 3.1 параметры TelegramAlertBot
6. Настройте профили-источники почтовых сообщений в п. 3.2 параметры MailModule
7. Запуск через start.sh


## 4.1 Описание параметров TelegramAlertBot
Данные параметры задаются в ./application.properties и отвечают конкретно за работу телеграмм бота.
Выгрузка почты с почтовых серверов настраивается отдельно в MailModule.

- **spring.data.mongodb.uri** - uri подключения к MongoDB. Необходимо задать хост и порт.
- **spring.data.mongodb.database** - название базы данных в MongoDB.
- **telegrambot.botUserName** - логин бота в telegram
- **telegrambot.secretPhrase** - секретная фраза, которую нужно будет вводить в чате, чтобы активировать чат.
- **telegrambot.helloMessage** - сообщение, которое будет рассылаться всем пользователям при запуске.
- **telegrambot.goodbyeMessage** - сообщение, которое будет рассылаться всем пользователям при критической ошибке.
- **telegrambot.maxAttemptsToSend** - количество попыток отправить сообщение в tg, после чего падает в критическую ошибку.
- **telegrambot.pythonBin** - путь до бинарника python, через который будет запускаться MailModule
- **telegrambot.pathToMailModule** - путь до MailModul
- **telegrambot.assignPulls** - Список командных пулов через запятую, на кого можно будет назначать письма, если 
вы используете функцию назначение письма на команду.


## 4.2 Описание параметров MailModule 
Данные параметры задаются в ./pythonMailModule/application.yaml и отвечают только 
за выгрузку модулем данных из почтового сервера в нашу MongoDB.
Источников почтовых сообщений может быть несколько и задаются они через профили ниже.

- **database.{db_name,host,port}** - реквизиты для подключения к MongoDB
- **attachments.path** - путь для сохранения вложений и картинок из писем
- **logging.path** - путь для логов от MailModule
- **logging.backupCount** - максимальное количество логов
- **logging.maxMegaBytes** - максимальный размер в мегабайтах одного лога 
- **logging.loggers.{name,lvl}** - название логера и его уровень
- **profiles** - массив профайлов. Каждый через профайл начинается с "-". Описывают источники email'ов.

### 4.2.1 Структура профилей-источников email'ов
Один профиль - это одна папка писем на конкретном почтовом сервере.
Из этой папки будут вычитываться сообщения, обрабатываться и заливаться в MongoDB.

  - **source** - реквизиты почты для конкретного профиля
  - **source.imap_host** - imap host почтового сервера
  - **source.login** - логин от почтового сервера, лучше использовать как переменную окружения из .env чререз !ENV ${env_name}
  - **source.password** - пароль от почтового сервера, лучше использовать как переменную окружения из .env чререз !ENV ${env_name}
  - **source.folder** - название папки, откуда будут браться письма. Без кирилицы. Общая папка называется ALL.
  - **replacements.\[{pattern,substr}\]** - список словарей, где указаны паттерны регулярных выражений и строки, на которые будет происходить
  - **image.max_width_px** - максимальная ширина конвертированного изображения из html. Большее будет обрезаться
  - **image.max_height_px** - максимальная высота изображения, если больше, то создастся следующее изображение.
  - **image.force_to_image** - true\false переводить всегда письма в картинку, даже если нет html. Некоторые письма с таблицами выгружаются чистым текстом. Данный параметр берет их версию с html разметкой.
  - **regex_last_string_mask** - регулярное выражение (python re) последней строки сообщения, после которого письмо будет обрезаться. Оставьте пустым, чтобы не использовать.
  - **filters** - параметры, которые будут исключать пришедшие письма из обработки.
  - **filters.receiver_regex_mask** - регулярное выражение (python re) получателя письма. Если не сходится, то письмо исключается.
  - **filters.restricted_subjects_regex** - список через "-" регулярных выражений (python re) запрещенных тем письма. Если сходится, то исключаем. Исключение "re:" используется, чтобы обрабатывать только первые пиьсма в теме.
  - **extra_fields** - словарь ключ-значение, которые будут добавлены к письму при добавлении его в MongoDB.
  - **extra_fields.enable_assigne** - true/false включает или отключает возможность назначать письма на ответственную команду в чате telegram.







